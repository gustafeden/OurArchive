rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users
    match /users/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // Households
    match /households/{hid} {

      // Anyone signed in can create a household
      allow create: if request.auth != null;

      // Members (including pending) can read - check the map value directly
      allow read: if request.auth != null
        && resource.data.members[request.auth.uid] is string;

      // Only owners can update/delete the household itself
      allow update: if isOwner(hid);
      allow delete: if isOwner(hid);

      // Items under household
      match /items/{itemId} {
        allow create: if request.auth != null
          && isMemberOfHousehold(hid)
          && request.resource.data.createdBy == request.auth.uid;

        allow read: if isMemberOfHousehold(hid);

        allow update: if isMemberOfHousehold(hid)
          && (resource.data.createdBy == request.auth.uid || isOwner(hid));

        allow delete: if isMemberOfHousehold(hid)
          && (resource.data.createdBy == request.auth.uid || isOwner(hid));
      }
    }

    // Global containers
    match /containers/{containerId} {
      allow create: if request.auth != null
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.householdId is string
        && isMemberOfHousehold(request.resource.data.householdId);

      allow read: if isMemberOfHousehold(resource.data.householdId);
      allow update: if isMemberOfHousehold(resource.data.householdId);
      allow delete: if isMemberOfHousehold(resource.data.householdId);
    }


    // Helper functions
    function isOwner(hid) {
      return request.auth != null
        && exists(/databases/$(database)/documents/households/$(hid))
        && get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] == 'owner';
    }

    function isMemberOfHousehold(hid) {
      return request.auth != null
        && exists(/databases/$(database)/documents/households/$(hid))
        // direct map lookup - returns the role (string) or null
        && get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] in ['owner','member','viewer'];
    }
  }
}
