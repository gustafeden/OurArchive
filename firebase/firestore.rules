rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users
    match /users/{uid} {
      allow read: if request.auth != null;
      // Users can write to their own document
      // OR household owners can update the households array when approving/removing members
      allow write: if request.auth != null &&
        (request.auth.uid == uid || canModifyUserHouseholds(uid));
    }

    // Households
    match /households/{hid} {

      // Anyone signed in can create a household
      allow create: if request.auth != null;

      // Members (including pending) can read - check the map value directly
      // Anyone can read to query by code (needed for joining)
      allow read: if request.auth != null;

      // Allow users to add themselves as pending members
      // Allow owners to update the household (approve members, remove members, etc.)
      allow update: if isOwner(hid)
        || canAddSelfAsPending(hid)
        || canRemoveMemberAsOwner(hid);

      allow delete: if isOwner(hid);

      // Items under household
      match /items/{itemId} {
        allow create: if request.auth != null
          && isMemberOfHousehold(hid)
          && request.resource.data.createdBy == request.auth.uid;

        allow read: if isMemberOfHousehold(hid);

        // Members and owners can update any item, viewers can only update their own
        allow update: if request.auth != null
          && exists(/databases/$(database)/documents/households/$(hid))
          && (get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] in ['owner', 'member']
              || (get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] == 'viewer'
                  && resource.data.createdBy == request.auth.uid));

        // Members and owners can delete any item, viewers can only delete their own
        allow delete: if request.auth != null
          && exists(/databases/$(database)/documents/households/$(hid))
          && (get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] in ['owner', 'member']
              || (get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] == 'viewer'
                  && resource.data.createdBy == request.auth.uid));
      }

      // Container types under household
      match /containerTypes/{typeId} {
        // All members can read types
        allow read: if isMemberOfHousehold(hid);

        // Only owners and members can create custom types
        allow create: if request.auth != null
          && isMemberOrOwner(hid)
          && request.resource.data.createdBy == request.auth.uid;

        // Only owners and members can update types
        // Default types cannot be updated (isDefault == true)
        allow update: if request.auth != null
          && isMemberOrOwner(hid)
          && resource.data.isDefault == false;

        // Only owners and members can delete custom types
        // Default types cannot be deleted (isDefault == true)
        allow delete: if request.auth != null
          && isMemberOrOwner(hid)
          && resource.data.isDefault == false;
      }

      // Item types under household
      match /itemTypes/{typeId} {
        // All members can read types
        allow read: if isMemberOfHousehold(hid);

        // Only owners and members can create custom types
        allow create: if request.auth != null
          && isMemberOrOwner(hid)
          && request.resource.data.createdBy == request.auth.uid;

        // Only owners and members can update types
        // Default types cannot be updated (isDefault == true)
        allow update: if request.auth != null
          && isMemberOrOwner(hid)
          && resource.data.isDefault == false;

        // Only owners and members can delete custom types
        // Default types cannot be deleted (isDefault == true)
        allow delete: if request.auth != null
          && isMemberOrOwner(hid)
          && resource.data.isDefault == false;
      }
    }

    // Global containers
    match /containers/{containerId} {
      allow create: if request.auth != null
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.householdId is string
        && isMemberOfHousehold(request.resource.data.householdId);

      allow read: if request.auth != null
        && 'householdId' in resource.data
        && resource.data.householdId is string
        && isMemberOfHousehold(resource.data.householdId);

      allow update: if request.auth != null
        && 'householdId' in resource.data
        && resource.data.householdId is string
        && isMemberOfHousehold(resource.data.householdId);

      allow delete: if request.auth != null
        && 'householdId' in resource.data
        && resource.data.householdId is string
        && isMemberOrOwner(resource.data.householdId);
    }


    // Helper functions
    function isOwner(hid) {
      return request.auth != null
        && exists(/databases/$(database)/documents/households/$(hid))
        && get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] == 'owner';
    }

    function isMemberOfHousehold(hid) {
      return request.auth != null
        && exists(/databases/$(database)/documents/households/$(hid))
        // direct map lookup - returns the role (string) or null
        && get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] in ['owner','member','viewer'];
    }

    function isMemberOrOwner(hid) {
      return request.auth != null
        && exists(/databases/$(database)/documents/households/$(hid))
        && get(/databases/$(database)/documents/households/$(hid)).data.members[request.auth.uid] in ['owner','member'];
    }

    function canAddSelfAsPending(hid) {
      let isNotMember = !(request.auth.uid in resource.data.members.keys());
      let isPendingInUpdate = request.resource.data.members[request.auth.uid] == 'pending';
      let onlyOneAdded = request.resource.data.members.size() == resource.data.members.size() + 1;
      let membersOnlyChanged = request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']);

      return request.auth != null
        && isNotMember
        && isPendingInUpdate
        && onlyOneAdded
        && membersOnlyChanged;
    }

    function canRemoveMemberAsOwner(hid) {
      return request.auth != null
        // User is an owner
        && resource.data.members[request.auth.uid] == 'owner'
        // Members map is being modified (one member removed or updated)
        && request.resource.data.members.size() <= resource.data.members.size()
        // All other fields remain unchanged
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']);
    }

    function canModifyUserHouseholds(uid) {
      // Only allow modifying the households array, nothing else
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['households'])
        // The households field must exist in both old and new data
        && 'households' in resource.data
        && 'households' in request.resource.data;
    }
  }
}
